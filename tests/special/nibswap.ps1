# This tries every possible nibble swap so we can inspect the volume
# directory after each try and see which one looks best

$fmt = Get-Content ultima4.fmt.json | ConvertFrom-Json
$nibs62 = @( 0x96, 0x97, 0x9a, 0x9b, 0x9d, 0x9e, 0x9f, 0xa6,
    0xa7, 0xab, 0xac, 0xad, 0xae, 0xaf, 0xb2, 0xb3,
    0xb4, 0xb5, 0xb6, 0xb7, 0xb9, 0xba, 0xbb, 0xbc,
    0xbd, 0xbe, 0xbf, 0xcb, 0xcd, 0xce, 0xcf, 0xd3,
    0xd6, 0xd7, 0xd9, 0xda, 0xdb, 0xdc, 0xdd, 0xde,
    0xdf, 0xe5, 0xe6, 0xe7, 0xe9, 0xea, 0xeb, 0xec,
    0xed, 0xee, 0xef, 0xf2, 0xf3, 0xf4, 0xf5, 0xf6,
    0xf7, 0xf9, 0xfa, 0xfb, 0xfc, 0xfd, 0xfe, 0xff)

foreach ($n in $nibs62) {
    $fmt.zones[0].swap_nibs[0] = @("d5",$n.ToString("X2"))
    $fmt | ConvertTo-Json -Depth 16 > scratch.json
    a2kit get -d ultima4.woz -t sec -f 17,0,15 --pro scratch.json
}